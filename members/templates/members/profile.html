{% extends 'base.html' %}

{% block title %}Mi Perfil{% endblock %}

{% block content %}
<div class="row">
    <!-- Columna de Navegación -->
    <div class="col-md-3">
        <div class="card">
            <div class="card-header"><strong>Hola, {{ user.first_name|default:user.username }}</strong></div>
            <div class="list-group list-group-flush" id="profileTabs" role="tablist">
                <a class="list-group-item list-group-item-action active" id="cuenta-tab" data-bs-toggle="list" href="#estado-cuenta" role="tab">Estado de Cuenta</a>
                <a class="list-group-item list-group-item-action" id="datos-tab" data-bs-toggle="list" href="#mis-datos" role="tab">Mis Datos</a>
                <form action="{% url 'logout' %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="list-group-item list-group-item-action text-danger w-100 text-start border-0 bg-transparent">Cerrar Sesión</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Columna de Contenido -->
    <div class="col-md-9">
        <div class="tab-content">
            <!-- Pestaña 1: Estado de Cuenta -->
            <div class="tab-pane fade show active" id="estado-cuenta" role="tabpanel">
                <h2>Estado de Cuenta</h2>
                <hr>
                <div class="card">
                    <div class="card-header"><strong>Mi Cuenta Corriente</strong></div>
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead><tr><th>Concepto</th><th>Monto</th><th>Vencimiento</th><th>Estado</th><th>Acción</th></tr></thead>
                            <tbody>
                                {% for invoice in invoices %}
                                    <tr>
                                        <td>{{ invoice.item.name }}</td>
                                        <td>${{ invoice.amount|floatformat:2 }}</td>
                                        <td>{{ invoice.due_date|date:"d/m/Y"|default:"-" }}</td>
                                        <td><span class="badge {% if invoice.status == 'PAG' %}bg-success{% elif invoice.status == 'PEN' %}bg-danger{% elif invoice.status == 'VER' %}bg-warning text-dark{% else %}bg-info text-dark{% endif %}">{{ invoice.get_status_display }}</span></td>
                                        <td>
                                            {% if invoice.status == 'PEN' %}
                                                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#paymentModal" data-invoice-id="{{ invoice.id }}" data-invoice-item="{{ invoice.item.name }}">Informar Pago</button>
                                            {% elif invoice.status == 'PAG' and invoice.payment %}
                                                <a href="{{ invoice.payment.receipt.url }}" target="_blank">Ver Comp.</a>
                                            {% else %} - {% endif %}
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr><td colspan="5" class="text-center text-muted">No tienes ítems en tu cuenta corriente.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pestaña 2: Mis Datos -->
            <div class="tab-pane fade" id="mis-datos" role="tabpanel">
                <h2>Mis Datos</h2>
                <hr>
                <div class="card">
                    <div class="card-body">
                        <form method="POST" action="{% url 'profile' %}" enctype="multipart/form-data">
                            {% csrf_token %}
                            <fieldset class="form-group"><legend class="border-bottom mb-4">Información de la Cuenta</legend>{{ u_form.as_p }}</fieldset>
                            <fieldset class="form-group mt-4"><legend class="border-bottom mb-4">Información Personal</legend>{{ p_form.as_p }}</fieldset>
                            <div class="form-group mt-4">
                                <button class="btn btn-primary" type="submit" name="update_profile">Actualizar Datos</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Subir Comprobante -->
<div class="modal fade" id="paymentModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Informar Pago para: <strong id="modalInvoiceItem"></strong></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <p><strong>CBU:</strong> 0000111122223333444455</p>
        <p><strong>Alias:</strong> OLIMPO.CLUB.RG</p>
        <hr>
        <form method="POST" enctype="multipart/form-data" action="{% url 'profile' %}">
            {% csrf_token %}
            <input type="hidden" name="invoice_id" id="modalInvoiceId">
            {{ receipt_form.as_p }}
            <div class="d-grid mt-3"><button class="btn btn-primary" type="submit" name="upload_receipt">Enviar Comprobante</button></div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const paymentModal = document.getElementById('paymentModal');
    if (paymentModal) {
        paymentModal.addEventListener('show.bs.modal', function (event) {
            // Botón que activó el modal
            const button = event.relatedTarget;
            // Extraemos los datos de los atributos data-*
            const invoiceId = button.getAttribute('data-invoice-id');
            const invoiceItem = button.getAttribute('data-invoice-item');

            // Seleccionamos los elementos dentro del modal para actualizarlos
            const modalInvoiceIdInput = paymentModal.querySelector('#modalInvoiceId');
            const modalInvoiceItemSpan = paymentModal.querySelector('#modalInvoiceItem');

            // Actualizamos los valores
            modalInvoiceIdInput.value = invoiceId;
            modalInvoiceItemSpan.textContent = invoiceItem;
        });
    }
});
</script>
{% endblock %}